<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥å» å“¡å·¥è¨‚é¤ç³»çµ±</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* æ¨£å¼èª¿æ•´ä»¥ç¬¦åˆéœ€æ±‚ */

        /* [NEW] èª¿æ•´é é¢å¯¬åº¦ */
        .container {
            max-width: 800px;
            /* å¢åŠ æœ€å¤§å¯¬åº¦ */
            margin: auto;
            padding: 20px;
        }

        #login-section input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        /* --- æ­·å²ç´€éŒ„å€å¡Šæ¨£å¼ (ç¶­æŒä¸è®Š) --- */
        /* ç§»é™¤åŸæœ‰çš„ #history-section æ¨£å¼ï¼Œå› ç‚ºå®ƒå·²è¢«ç§»åˆ°é ç±¤å…§ */
        .history-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .history-date-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .history-date-inputs label {
            white-space: nowrap;
        }

        .history-quick-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .history-quick-buttons button {
            padding: 5px 10px;
            border: 1px solid #007bff;
            background-color: #fff;
            color: #007bff;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .history-quick-buttons button:hover {
            background-color: #e6f7ff;
        }

        #history-result table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        #history-result th,
        #history-result td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        #history-result th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }

        #history-result tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .history-record {
            display: none;
        }

        /* --- END æ­·å²ç´€éŒ„å€å¡Šæ¨£å¼ --- */

        /* [UPDATED] é ç±¤æ¨£å¼ - è¨˜äº‹æœ¬é¢¨æ ¼ */
        .order-tabs {
            display: flex;
            margin-bottom: 0;
            border-bottom: 1px solid #ddd;
        }

        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            border: 1px solid #ddd;
            border-bottom: none;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            /* æœªé¸å®šï¼šé»‘å­— */
            background-color: #f0f0f0;
            /* æœªé¸å®šï¼šæ·ºç°åº• */
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            margin-right: 2px;
            transition: background-color 0.2s, color 0.2s;
        }

        .tab-button.active {
            color: white;
            /* é¸å®šï¼šç™½å­— */
            background-color: #007bff;
            /* é¸å®šï¼šè—åº• */
            border-color: #007bff;
            position: relative;
            z-index: 1;
            margin-bottom: -1px;
            /* è¦†è“‹ order-tabs çš„ border-bottom */
        }

        .tab-content {
            display: none;
            padding: 15px;
            /* å¢åŠ  padding */
            border: 1px solid #ddd;
            /* æ–°å¢é‚Šæ¡† */
            border-top: none;
            /* ä¸Šé‚Šæ¡†è¢« active tab è¦†è“‹ */
            min-height: 250px;
            /* é¿å…é é¢è·³å‹• */
        }

        .tab-content.active {
            display: block;
        }

        /* [END UPDATED] é ç±¤æ¨£å¼ */

        /* [NEW] é€±è¨‚å–®è¡¨æ ¼æ¨£å¼èª¿æ•´ï¼šä¸æ›è¡Œ */
        #weekly-order-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            table-layout: fixed;
        }

        #weekly-order-table th,
        #weekly-order-table td {
            border: 1px solid #ddd;
            padding: 8px 4px;
            text-align: center;
            vertical-align: top;
        }

        /* å¼·åˆ¶è¡¨æ ¼å„²å­˜æ ¼å…§å®¹ä¸æ›è¡Œ */
        #weekly-order-table td {
            white-space: nowrap;
        }

        #weekly-order-table th {
            background-color: #f0f0f0;
        }

        /* èª¿æ•´é¸å–®å¯¬åº¦ï¼Œè®“å…©å€‹é¸å–®èƒ½åœ¨åŒä¸€è¡Œé¡¯ç¤º */
        #weekly-order-table select {
            width: 48%;
            display: inline-block;
            margin: 0 1%;
            padding: 5px 2px;
            box-sizing: border-box;
        }

        .week-order-controls {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #f7f7f7;
        }

        .week-select-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .week-select-group label {
            white-space: nowrap;
        }

        .week-select-group select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-grow: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>å·¥å» å“¡å·¥è¨‚é¤ç³»çµ±</h2>

        <div id="login-section">
            <input type="text" id="employee-id" placeholder="è«‹è¼¸å…¥æ‚¨çš„å“¡å·¥ç·¨è™Ÿ(93800)">
            <input type="password" id="employee-password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼(1234)">
            <button class="btn btn-order" onclick="login()">ç™»å…¥</button>
        </div>

        <div id="order-section" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <p style="margin: 0;"><strong>æ­¡è¿æ‚¨ï¼Œ<span id="employee-name"></span>ï¼</strong></p>
                <button class="btn btn-cancel" onclick="logout()" style="width: auto; padding: 5px 10px;">ç™»å‡º</button>
            </div>

            <div class="order-tabs">
                <button class="tab-button active" onclick="openOrderTab(event, 'TodayOrder')">ä»Šæ—¥è¨‚é¤</button>
                <button class="tab-button" onclick="openOrderTab(event, 'WeeklyOrder')">ä¸€é€±/ç•¶æœˆè¨‚é¤</button>
                <button class="tab-button" onclick="openOrderTab(event, 'HistoryOrder')"> æ­·å²ç´€éŒ„æŸ¥è©¢</button>
            </div>
            <div id="TodayOrder" class="tab-content active">
                <div id="status-message" class="message"></div>
                <p>
                    ä»Šæ—¥è¨‚é¤æˆªæ­¢æ™‚é–“ï¼š<strong style="color: red;">åˆé¤ 08:30 / æ™šé¤ 16:00 (4:00 PM)</strong>
                    <br>
                    ç›®å‰æ™‚é–“ï¼š<span id="current-time"></span>
                </p>

                <div class="meal-selection">
                    <div class="meal-box lunch">
                        <h3>åˆé¤ (Lunch)</h3>
                        <p id="lunch-status">å°šæœªè¨‚è³¼</p>
                        <button class="btn btn-order" id="order-lunch-btn" onclick="openModal('LUNCH')">æˆ‘è¦è¨‚è³¼</button>
                        <button class="btn btn-cancel" id="cancel-lunch-btn" onclick="cancelOrder('LUNCH')"
                            style="display: none;">å–æ¶ˆè¨‚å–®</button>
                    </div>

                    <div class="meal-box dinner">
                        <h3>æ™šé¤ (Dinner)</h3>
                        <p id="dinner-status">å°šæœªè¨‚è³¼</p>
                        <button class="btn btn-order" id="order-dinner-btn" onclick="openModal('DINNER')">æˆ‘è¦è¨‚è³¼</button>
                        <button class="btn btn-cancel" id="cancel-dinner-btn" onclick="cancelOrder('DINNER')"
                            style="display: none;">å–æ¶ˆè¨‚å–®</button>
                    </div>
                </div>
            </div>

            <div id="WeeklyOrder" class="tab-content">
                <h3>ğŸ“… é è¨‚ä¸€é€±/ç•¶æœˆ(é€±ä¸€è‡³é€±äº”)</h3>
                <p class="alert-info" style="margin-bottom: 10px;">è«‹æ³¨æ„ï¼šä»»ä½•å·²æˆªæ­¢çš„æ—¥æœŸå°‡ç„¡æ³•ä¿®æ”¹ï¼Œæ­¤è™•çš„è¨­å®šå°‡è¦†è“‹è©²é€±æ‚¨å·²æœ‰çš„è¨‚å–®ã€‚</p>

                <div class="week-order-controls">
                    <div class="week-select-group">
                        <label for="week-select">é¸æ“‡é€±åˆ¥:</label>
                        <select id="week-select" onchange="loadWeeklyOrderTable()">
                            <option value="current">æœ¬é€±</option>
                            <option value="next">ä¸‹é€±</option>
                            <option value="month">ç•¶æœˆå…¨éƒ¨é€±åˆ¥</option>
                        </select>

                        <label for="default-meal-type">é è¨­é¤åˆ¥:</label>
                        <select id="default-meal-type" onchange="applyDefaultOptions()">
                            <option value="BOTH">åˆé¤+æ™šé¤</option>
                            <option value="LUNCH">åˆé¤</option>
                            <option value="DINNER">æ™šé¤</option>
                        </select>
                    </div>

                    <div class="week-select-group">
                        <label for="default-diet">é è¨­è‘·ç´ :</label>
                        <select id="default-diet" onchange="applyDefaultOptions()">
                            <option value="MEAT">è‘·é£Ÿ</option>
                            <option value="VEG">ç´ é£Ÿ</option>
                        </select>

                        <label for="default-rice">é è¨­é£¯é‡:</label>
                        <select id="default-rice" onchange="applyDefaultOptions()">
                            <option value="FULL">å…¨é£¯</option>
                            <option value="HALF">åŠé£¯</option>
                        </select>
                    </div>
                    <p class="alert-danger" id="weekly-warning" style="margin: 0; padding: 5px; display: none;"></p>
                </div>

                <table id="weekly-order-table">
                    <thead>
                        <tr>
                            <th style="width: 18%;">æ—¥æœŸ</th>
                            <th style="width: 10%;">æ˜ŸæœŸ</th>
                            <th style="width: 33%;">åˆé¤é¸é …</th>
                            <th style="width: 33%;">æ™šé¤é¸é …</th>
                            <th style="width: 6%;">æˆªæ­¢</th>
                        </tr>
                    </thead>
                    <tbody id="weekly-order-list">
                        <tr>
                            <td colspan="5">è«‹é¸æ“‡é€±åˆ¥ä»¥è¼‰å…¥è¨‚å–®...</td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn btn-order" style="margin-top: 20px; width: 100%;" onclick="saveWeeklyOrders()">âœ…
                    ç¢ºèªå„²å­˜è¨‚å–®</button>
            </div>

            <div id="HistoryOrder" class="tab-content">
                <div class="history-controls">
                    <div class="history-quick-buttons">
                        <button onclick="setQuickRange('thisWeek')">æœ¬é€±</button>
                        <button onclick="setQuickRange('lastWeek')">ä¸Šé€±</button>
                        <button onclick="setQuickRange('thisMonth')">æœ¬æœˆ</button>
                        <button onclick="setQuickRange('lastMonth')">ä¸Šæœˆ</button>
                    </div>

                    <div class="history-date-inputs">
                        <label for="history-date-from">å¾:</label>
                        <input type="date" id="history-date-from" style="flex: 1;">
                        <label for="history-date-to">åˆ°:</label>
                        <input type="date" id="history-date-to" style="flex: 1;">
                        <button class="btn btn-order" style="width: 100px;" onclick="loadHistoryOrders()">æŸ¥è©¢</button>
                    </div>
                </div>

                <div id="history-result">
                    <p style="color: #666;">è«‹è¼¸å…¥æ—¥æœŸå€é–“æˆ–ä½¿ç”¨å¿«æ·æŒ‰éˆ•æŸ¥è©¢ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">è¨‚è³¼é¤é»</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="option-group">
                <label>é¸æ“‡ä¸€ï¼šè‘·ç´ </label>
                <input type="radio" id="diet-meat" name="diet" value="MEAT" checked>
                <label for="diet-meat">è‘·é£Ÿ</label>
                <input type="radio" id="diet-veg" name="diet" value="VEG">
                <label for="diet-veg">ç´ é£Ÿ</label>
            </div>

            <div class="option-group">
                <label>é¸æ“‡äºŒï¼šé£¯é‡</label>
                <input type="radio" id="rice-full" name="rice" value="FULL" checked>
                <label for="rice-full">å…¨é£¯</label>
                <input type="radio" id="rice-half" name="rice" value="HALF">
                <label for="rice-half">åŠé£¯</label>
            </div>

            <button class="btn btn-order" onclick="confirmOrder()">ç¢ºèªè¨‚è³¼</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸èˆ‡è³‡æ–™ ---
        // [UPDATED] æ›´æ”¹ç‚ºé¤é»å°ˆå±¬çš„æˆªæ­¢æ™‚é–“
        const LUNCH_CUTOFF_HOUR = 8;
        const LUNCH_CUTOFF_MINUTE = 30;
        const DINNER_CUTOFF_HOUR = 16; // 16 é» (4:00 PM)
        const DINNER_CUTOFF_MINUTE = 0;

        let currentMealType = '';
        let loggedInEmpId = null;

        const employeeData = {
            '93800': 'æ—æ·‘éˆº',
            '28109': 'è©¹é‡‘ç’‹',
            '2400305': 'ç‹ç€šç« ',
        };
        const DUMMY_PASSWORD = '1234';

        const mealMap = { LUNCH: 'åˆé¤', DINNER: 'æ™šé¤' };
        const dietMap = { MEAT: 'è‘·é£Ÿ', VEG: 'ç´ é£Ÿ' };
        const riceMap = { FULL: 'å…¨é£¯', HALF: 'åŠé£¯' };

        async function getOrders(dateFrom = null, dateTo = null) {
            if (dateFrom && dateTo) {
                // æ­·å²æŸ¥è©¢ï¼šæŒ‡å®šæ—¥æœŸç¯„åœ
                const response = await fetch(`/api/employee/history?dateFrom=${dateFrom}&dateTo=${dateTo}`);
                const result = await response.json();
                return result.success ? result.data : {};
            } else {
                // é è¨­ï¼šå–å¾—ä»Šæ—¥è¨‚å–®ï¼ˆçµ¦ loadWeeklyOrderTableï¼‰
                const response = await fetch('/api/employee/today-orders');
                const result = await response.json();
                return result.success ? result.data : {};
            }
        }

        async function saveOrders(empId, mealType, dietType, ricePortion, dateStr = formatDate(new Date())) {
            try {
                const response = await fetch('/api/employee/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        MealType: mealType,
                        DietType: dietType,
                        RicePortion: ricePortion,
                        Date: dateStr
                    })
                });

                const result = await response.json();
                return result.success ? result.message : null;
            } catch (error) {
                console.error('å„²å­˜è¨‚å–®å¤±æ•—:', error);
                return null;
            }
        }

        // --- è¼”åŠ©å‡½å¼ï¼šæ—¥æœŸæ ¼å¼åŒ– ---
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // è¼”åŠ©å‡½å¼ï¼šå–å¾—æ˜ŸæœŸå¹¾
        function getDayOfWeek(date) {
            const dayNames = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
            return dayNames[date.getDay()];
        }

        // è¼”åŠ©å‡½å¼ï¼šç²å–ç•¶å‰æ™‚é–“ä»£ç¢¼
        function getCurrentTimeCode() {
            const now = new Date();
            return now.getHours() * 100 + now.getMinutes();
        }

        // --- ç™»å‡ºåŠŸèƒ½ ---
        function logout() {
            loggedInEmpId = null;
            document.getElementById('employee-id').value = '';
            document.getElementById('employee-password').value = '';
            document.getElementById('order-section').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';
            alert('æ‚¨å·²æˆåŠŸç™»å‡ºã€‚');
            // æ¸…ç©ºæ­·å²ç´€éŒ„é¡¯ç¤º
            document.getElementById('history-result').innerHTML = '<p style="color: #666;">è«‹è¼¸å…¥æ—¥æœŸå€é–“æˆ–ä½¿ç”¨å¿«æ·æŒ‰éˆ•æŸ¥è©¢ã€‚</p>';
        }

        // --- è¼”åŠ©å‡½å¼ï¼šè¨ˆç®—å¿«æ·æ—¥æœŸå€é–“ ---
        function setQuickRange(period) {
            const today = new Date();
            let startDate, endDate;

            switch (period) {
                case 'thisWeek':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay());
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                case 'lastWeek':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay() - 7);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                case 'thisMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'lastMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                default:
                    return;
            }

            document.getElementById('history-date-from').value = formatDate(startDate);
            document.getElementById('history-date-to').value = formatDate(endDate);
            loadHistoryOrders();
        }

        // --- æ™‚é–“æ§åˆ¶ [UPDATED]ï¼šæª¢æŸ¥ç‰¹å®šé¤åˆ¥æ˜¯å¦æˆªæ­¢ ---
        function checkCutoff(mealType, dateKey = formatDate(new Date())) {
            const todayKey = formatDate(new Date());
            // åªæœ‰åœ¨è™•ç†ä»Šå¤©çš„è¨‚å–®æ™‚æ‰æª¢æŸ¥æ™‚é–“æˆªæ­¢
            if (dateKey !== todayKey) return false;

            const timeCode = getCurrentTimeCode();
            let cutoffTime;

            if (mealType === 'LUNCH') {
                cutoffTime = LUNCH_CUTOFF_HOUR * 100 + LUNCH_CUTOFF_MINUTE; // 830
            } else if (mealType === 'DINNER') {
                cutoffTime = DINNER_CUTOFF_HOUR * 100 + DINNER_CUTOFF_MINUTE; // 1600
            } else {
                return false;
            }

            return timeCode > cutoffTime;
        }

        function updateTimeDisplay() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        setInterval(updateTimeDisplay, 1000);

        // --- ç™»å…¥/èº«ä»½ç¢ºèª (å«å¯†ç¢¼) ---
        async function login() {
            const empIdInput = document.getElementById('employee-id').value.toUpperCase().trim();
            const passwordInput = document.getElementById('employee-password').value;

            try {
                const response = await fetch('/api/employee/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        EmpId: empIdInput,      // â† å‘¼å«å¾Œç«¯ VerifyEmployee
                        Password: passwordInput
                    })
                });

                const result = await response.json();

                if (result.success) {
                    loggedInEmpId = result.employee.empID;  // â† å‰ç«¯è®Šæ•¸
                    document.getElementById('employee-name').textContent = result.employee.empName;
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('order-section').style.display = 'block';
                    document.getElementById('TodayOrder').style.display = 'block';
                    setQuickRange('thisMonth');
                    await updateOrderUI();  // â† è¼‰å…¥çœŸå¯¦è¨‚å–®
                } else {
                    alert(result.message || 'ç™»å…¥å¤±æ•—');
                }
            } catch (error) {
                alert('ä¼ºæœå™¨é€£ç·šå¤±æ•—');
            }
        }

        // [UPDATED] é ç±¤åˆ‡æ›é‚è¼¯
        function openOrderTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            if (tabName === 'WeeklyOrder') {
                loadWeeklyOrderTable();
            } else if (tabName === 'HistoryOrder') {
                // å¦‚æœæ˜¯åˆ‡æ›åˆ°æ­·å²ç´€éŒ„é ç±¤ï¼Œå¼·åˆ¶é‡æ–°è¼‰å…¥è³‡æ–™ (ç¢ºä¿æ—¥æœŸå€é–“çš„è³‡æ–™æ˜¯æœ€æ–°)
                loadHistoryOrders();
            } else {
                updateOrderUI();
            }
        }

        // --- UI æ›´æ–°é‚è¼¯ (ä»Šæ—¥è¨‚é¤) [UPDATED]ï¼šæª¢æŸ¥é¤é»å°ˆå±¬æˆªæ­¢æ™‚é–“ ---
        function updateOrderUI() {
            if (!loggedInEmpId) return;

            const today = formatDate(new Date());
            const orders = getOrders();

            const isLunchCutoff = checkCutoff('LUNCH');
            const isDinnerCutoff = checkCutoff('DINNER');
            const isAllCutoff = isLunchCutoff && isDinnerCutoff;

            const statusMessage = document.getElementById('status-message');

            // 1. è™•ç†æˆªæ­¢ç‹€æ…‹
            if (isAllCutoff) {
                statusMessage.className = 'message alert-danger';
                statusMessage.textContent = 'ä»Šæ—¥è¨‚é¤æ™‚é–“å·²æˆªæ­¢ (åˆé¤ 08:30 / æ™šé¤ 16:00)ã€‚æ‚¨å·²ç„¡æ³•ä¿®æ”¹è¨‚å–®ã€‚';
            } else if (isLunchCutoff && !isDinnerCutoff) {
                statusMessage.className = 'message alert-warning';
                statusMessage.textContent = 'ä»Šæ—¥åˆé¤è¨‚é¤å·²æˆªæ­¢ (08:30)ã€‚æ™šé¤è¨‚é¤ä»é–‹æ”¾è‡³ 16:00ã€‚';
            } else {
                statusMessage.className = 'message alert-success';
                statusMessage.textContent = 'è¨‚é¤æ™‚é–“å…§ï¼Œæ‚¨å¯ä»¥éš¨æ™‚ä¿®æ”¹æˆ–å–æ¶ˆã€‚';
            }

            // 2. è™•ç†ä»Šæ—¥è¨‚å–®é¡¯ç¤º
            ['LUNCH', 'DINNER'].forEach(meal => {
                const key = `${today}_${loggedInEmpId}_${meal}`;
                const order = orders[key];
                const orderBtn = document.getElementById(`order-${meal.toLowerCase()}-btn`);
                const cancelBtn = document.getElementById(`cancel-${meal.toLowerCase()}-btn`);
                const statusP = document.getElementById(`${meal.toLowerCase()}-status`);

                const isMealCutoff = checkCutoff(meal);
                const isBeforeCutoff = !isMealCutoff;

                if (order && order.IsOrdered) {
                    const dietText = dietMap[order.DietType];
                    const riceText = riceMap[order.RicePortion];
                    statusP.textContent = `âœ… å·²è¨‚è³¼ (${dietText} / ${riceText})`;
                    statusP.style.color = '#155724';
                    orderBtn.style.display = 'none';
                    // åªæœ‰åœ¨æˆªæ­¢å‰æ‰é¡¯ç¤ºå–æ¶ˆæŒ‰éˆ•
                    if (isBeforeCutoff) cancelBtn.style.display = 'block'; else cancelBtn.style.display = 'none';

                    // æŒ‰éˆ•ç¦ç”¨ç‹€æ…‹
                    orderBtn.disabled = true;
                    cancelBtn.disabled = !isBeforeCutoff;
                } else {
                    statusP.textContent = 'å°šæœªè¨‚è³¼';
                    statusP.style.color = '#333';
                    // åªæœ‰åœ¨æˆªæ­¢å‰æ‰é¡¯ç¤ºè¨‚è³¼æŒ‰éˆ•
                    if (isBeforeCutoff) orderBtn.style.display = 'block'; else orderBtn.style.display = 'none';
                    cancelBtn.style.display = 'none';

                    // æŒ‰éˆ•ç¦ç”¨ç‹€æ…‹
                    orderBtn.disabled = !isBeforeCutoff;
                    cancelBtn.disabled = true;
                }
            });
        }

        // --- æ ¸å¿ƒè¨‚è³¼/å–æ¶ˆé‚è¼¯ [UPDATED]ï¼šæª¢æŸ¥é¤é»å°ˆå±¬æˆªæ­¢æ™‚é–“ ---
        function openModal(mealType) {
            if (checkCutoff(mealType)) { // [UPDATED]
                alert('è¨‚é¤æ™‚é–“å·²æˆªæ­¢ï¼');
                return;
            }
            currentMealType = mealType;
            document.getElementById('modal-title').textContent = mealType === 'LUNCH' ? 'è¨‚è³¼åˆé¤é¸é …' : 'è¨‚è³¼æ™šé¤é¸é …';
            document.getElementById('orderModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
            currentMealType = '';
        }

        async function confirmOrder() {
            if (!loggedInEmpId) {
                alert('è«‹å…ˆç™»å…¥ï¼');
                return;
            }

            const dietType = document.querySelector('input[name="diet"]:checked')?.value;
            const ricePortion = document.querySelector('input[name="rice"]:checked')?.value;

            if (!dietType || !ricePortion) {
                alert('è«‹é¸æ“‡é¤é»é¸é …ï¼');
                return;
            }

            try {
                const response = await fetch('/api/employee/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        MealType: currentMealType,
                        DietType: dietType,
                        RicePortion: ricePortion,
                        Date: formatDate(new Date())
                    })
                });

                const result = await response.json();

                if (result.success) {
                    closeModal();
                    await updateOrderUI();
                    alert(`è¨‚è³¼ ${currentMealType === 'LUNCH' ? 'åˆé¤' : 'æ™šé¤'} æˆåŠŸï¼ (${dietMap[dietType]} / ${riceMap[ricePortion]})`);
                } else {
                    alert(result.message || 'è¨‚è³¼å¤±æ•—');
                }
            } catch (error) {
                console.error('è¨‚è³¼éŒ¯èª¤:', error);
                alert('è¨‚è³¼å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        function cancelOrder(mealType) {
            if (!loggedInEmpId) return;
            if (checkCutoff(mealType)) { // [UPDATED]
                alert('è¨‚é¤æ™‚é–“å·²æˆªæ­¢ï¼Œç„¡æ³•å–æ¶ˆï¼');
                return;
            }
            if (!confirm(`ç¢ºå®šè¦å–æ¶ˆä»Šæ—¥çš„ ${mealType === 'LUNCH' ? 'åˆé¤' : 'æ™šé¤'} è¨‚å–®å—ï¼Ÿ`)) return;

            const today = formatDate(new Date());
            const key = `${today}_${loggedInEmpId}_${mealType}`;
            const orders = getOrders();

            if (orders[key]) {
                delete orders[key];
                saveOrders(orders);
                updateOrderUI();
                alert(`å·²å–æ¶ˆ ${mealType === 'LUNCH' ? 'åˆé¤' : 'æ™šé¤'} è¨‚å–®ã€‚`);
            }
        }

        // --- [MODIFIED] ä¸€é€±/ç•¶æœˆè¨‚é¤åŠŸèƒ½ï¼šæ›´æ–°æˆªæ­¢æ™‚é–“åˆ¤æ–· ---
        function getDatesRange(type) {
            const today = new Date();
            const dates = [];

            if (type === 'current' || type === 'next') {
                let start = new Date(today);
                let day = start.getDay();

                let offset = day === 0 ? -6 : 1 - day; // ç®—åˆ°æœ¬é€±ä¸€

                if (type === 'next') {
                    offset += 7;
                }

                start.setDate(today.getDate() + offset);

                for (let i = 0; i < 5; i++) {
                    const date = new Date(start);
                    date.setDate(start.getDate() + i);
                    dates.push(date);
                }
            } else if (type === 'month') {
                // ç²å–ç•¶æœˆçš„ç¬¬ä¸€å¤©
                const year = today.getFullYear();
                const month = today.getMonth();
                let currentDate = new Date(year, month, 1);

                while (currentDate.getMonth() === month) {
                    const dayOfWeek = currentDate.getDay(); // 0=æ—¥, 6=å…­
                    // åªåŒ…å«é€±ä¸€ (1) åˆ°é€±äº” (5)
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                        dates.push(new Date(currentDate));
                    }
                    // ç§»è‡³ä¸‹ä¸€å¤©
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
            return dates;
        }

        function loadWeeklyOrderTable() {
            if (!loggedInEmpId) return;

            const weekType = document.getElementById('week-select').value;
            const datesRange = getDatesRange(weekType);
            const listBody = document.getElementById('weekly-order-list');
            listBody.innerHTML = '';
            const allOrders = getOrders();
            const todayKey = formatDate(new Date());
            const warningEl = document.getElementById('weekly-warning');

            warningEl.style.display = 'none';

            if (datesRange.length === 0) {
                listBody.innerHTML = '<tr><td colspan="5">ç„¡å·¥ä½œæ—¥è³‡æ–™...</td></tr>';
                return;
            }

            datesRange.forEach(date => {
                const dateKey = formatDate(date);
                const dayOfWeek = getDayOfWeek(date);

                // åˆ¤æ–·æ—¥æœŸæ˜¯å¦å·²é
                const dateOnly = new Date(dateKey + 'T00:00:00');
                const todayOnly = new Date(todayKey + 'T00:00:00');
                const isPastDate = dateOnly < todayOnly;

                // åˆ¤æ–·ä»Šæ—¥çš„åˆé¤/æ™šé¤æ˜¯å¦æˆªæ­¢ (åŒ…å«éå»æ—¥æœŸ)
                const isLunchCutoff = isPastDate || checkCutoff('LUNCH', dateKey);
                const isDinnerCutoff = isPastDate || checkCutoff('DINNER', dateKey);

                // ç¶œåˆåˆ¤æ–·ï¼Œç”¨æ–¼è¡ŒèƒŒæ™¯å’Œè­¦å‘Šè¨Šæ¯
                const isCutoff = isLunchCutoff && isDinnerCutoff;

                if (dateKey === todayKey) {
                    let warningText = '';
                    if (isLunchCutoff && isDinnerCutoff) {
                        warningText = 'âš ï¸ ä»Šæ—¥åˆé¤å’Œæ™šé¤è¨‚é¤æ™‚é–“çš†å·²æˆªæ­¢ï¼Œç„¡æ³•ä¿®æ”¹ä»Šæ—¥çš„è¨‚å–®ã€‚';
                    } else if (isLunchCutoff) {
                        warningText = 'âš ï¸ ä»Šæ—¥åˆé¤è¨‚é¤å·²æˆªæ­¢ (08:30)ï¼Œä½†æ™šé¤è¨‚å–®ä»å¯ä¿®æ”¹ã€‚';
                    }
                    if (warningText) {
                        warningEl.textContent = warningText;
                        warningEl.style.display = 'block';
                    }
                }

                // ç²å–ç¾æœ‰è¨‚å–®ç‹€æ…‹
                const lunchKey = `${dateKey}_${loggedInEmpId}_LUNCH`;
                const dinnerKey = `${dateKey}_${loggedInEmpId}_DINNER`;
                const existingLunch = allOrders[lunchKey];
                const existingDinner = allOrders[dinnerKey];

                const tr = document.createElement('tr');
                tr.setAttribute('data-date', dateKey);
                tr.style.backgroundColor = isCutoff ? '#fff0f0' : 'white';

                // Disabled attribute now depends on meal type cutoff
                const disabledLunchAttr = isLunchCutoff ? 'disabled' : '';
                const disabledDinnerAttr = isDinnerCutoff ? 'disabled' : '';

                // Cutoff text now reflects the status more generally
                const cutoffText = isCutoff ? 'âœ…' :
                    (isLunchCutoff || isDinnerCutoff) ? 'éƒ¨åˆ†' : 'âŒ'; // Updated cutoff status text


                const generateOptions = (mealType, existingOrder) => {
                    const existingDiet = existingOrder ? existingOrder.DietType : '';
                    const existingRice = existingOrder ? existingOrder.RicePortion : '';

                    // ä½¿ç”¨é¤åˆ¥å°ˆå±¬çš„ç¦ç”¨å±¬æ€§
                    const disabledAttr = mealType === 'LUNCH' ? disabledLunchAttr : disabledDinnerAttr;

                    const dietHtml = `
                        <select name="${mealType.toLowerCase()}-diet-${dateKey}" class="week-diet form-control" ${disabledAttr}>
                            <option value="">æœªè¨‚è³¼/å–æ¶ˆ</option>
                            <option value="MEAT" ${existingDiet === 'MEAT' ? 'selected' : ''}>è‘·é£Ÿ</option>
                            <option value="VEG" ${existingDiet === 'VEG' ? 'selected' : ''}>ç´ é£Ÿ</option>
                        </select>
                    `;
                    const riceHtml = `
                        <select name="${mealType.toLowerCase()}-rice-${dateKey}" class="week-rice form-control" ${disabledAttr}>
                            <option value="">--</option>
                            <option value="FULL" ${existingRice === 'FULL' ? 'selected' : ''}>å…¨é£¯</option>
                            <option value="HALF" ${existingRice === 'HALF' ? 'selected' : ''}>åŠé£¯</option>
                        </select>
                    `;
                    return dietHtml + riceHtml;
                };

                tr.innerHTML = `
                    <td>${dateKey}</td>
                    <td>(é€±${dayOfWeek})</td>
                    <td>${generateOptions('LUNCH', existingLunch)}</td>
                    <td>${generateOptions('DINNER', existingDinner)}</td>
                    <td>${cutoffText}</td>
                `;
                listBody.appendChild(tr);
            });

            applyDefaultOptions();
        }

        // å¥—ç”¨é è¨­é¸é …åˆ°è¡¨æ ¼ (åƒ…å½±éŸ¿é¸é …ç‚º '-- æœªè¨‚è³¼' çš„æ¬„ä½)
        function applyDefaultOptions() {
            const defaultDiet = document.getElementById('default-diet').value;
            const defaultRice = document.getElementById('default-rice').value;
            const mealTypeSelect = document.getElementById('default-meal-type').value;

            document.querySelectorAll('#weekly-order-list tr').forEach(row => {
                const dateKey = row.getAttribute('data-date');

                // æª¢æŸ¥åˆé¤æ˜¯å¦å·²æˆªæ­¢
                const lunchDietEl = row.querySelector(`select[name="lunch-diet-${dateKey}"]`);
                if (lunchDietEl && lunchDietEl.disabled) return;  // å·²æˆªæ­¢æ•´è¡Œè·³é

                const processMeal = (mealType, defaultState) => {
                    const dietEl = row.querySelector(`select[name="${mealType.toLowerCase()}-diet-${dateKey}"]`);
                    const riceEl = row.querySelector(`select[name="${mealType.toLowerCase()}-rice-${dateKey}"]`);
                    if (!dietEl || !riceEl) return;

                    if (defaultState) {
                        // å¡«é è¨­ï¼ˆç©ºç™½æ‰å¡«ï¼‰
                        if (dietEl.value === '') {
                            dietEl.value = defaultDiet;
                            riceEl.value = defaultRice;
                        }
                    } else {
                        // æ¸…ç©ºé‚è¼¯ï¼šåˆ‡æ›é¤åˆ¥æ™‚æ¸…ç©ºå¦ä¸€é¤
                        if (dietEl.value !== '') {
                            if ((mealType === 'LUNCH' && mealTypeSelect === 'DINNER') ||
                                (mealType === 'DINNER' && mealTypeSelect === 'LUNCH')) {
                                dietEl.value = '';
                                riceEl.value = '';
                            }
                        }
                    }
                };

                const lunchDefault = (mealTypeSelect === 'LUNCH' || mealTypeSelect === 'BOTH');
                processMeal('LUNCH', lunchDefault);
                const dinnerDefault = (mealTypeSelect === 'DINNER' || mealTypeSelect === 'BOTH');
                processMeal('DINNER', dinnerDefault);
            });

            // reload é¡¯ç¤ºå¾Œç«¯ç‹€æ…‹ï¼Œä¸‹å€‹äº‹ä»¶å¾ªç’°åŸ·è¡Œï¼Œè¨­å®š10ms å»¶é²ï¼Œé¿å…è§¸ç™¼ onchange
            setTimeout(() => loadWeeklyOrderTable(), 10);
        }



        async function saveWeeklyOrders() {
            if (!loggedInEmpId) {
                alert('è«‹å…ˆç™»å…¥ï¼');
                return;
            }

            if (!confirm('ç¢ºèªå„²å­˜æ‰€é¸çš„ä¸€é€±/ç•¶æœˆè¨‚å–®å—ï¼Ÿé€™å°‡æœƒè¦†è“‹æ‚¨åŸæœ‰çš„è¨‚å–®ï¼Œä¸¦å¿½ç•¥å·²æˆªæ­¢çš„æ—¥æœŸã€‚')) return;

            let ordersToSave = [];
            let processedCount = 0;

            document.querySelectorAll('#weekly-order-list tr').forEach(row => {
                const dateKey = row.getAttribute('data-date');

                ['LUNCH', 'DINNER'].forEach(mealType => {
                    const dietEl = row.querySelector(`select[name="${mealType.toLowerCase()}-diet-${dateKey}"]`);
                    const riceEl = row.querySelector(`select[name="${mealType.toLowerCase()}-rice-${dateKey}"]`);

                    if (!dietEl || dietEl.disabled) return;

                    if (dietEl.value && riceEl.value) {
                        ordersToSave.push({
                            Date: dateKey,
                            MealType: mealType,
                            DietType: dietEl.value,
                            RicePortion: riceEl.value
                        });
                        processedCount++;
                    }
                });
            });

            try {
                const response = await fetch('/api/employee/weekly-orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Orders: ordersToSave })
                });

                const result = await response.json();

                if (result.success) {
                    await loadWeeklyOrderTable();
                    await updateOrderUI();
                    alert(`ä¸€é€±/ç•¶æœˆè¨‚å–®å„²å­˜æˆåŠŸï¼å…±è™•ç† ${result.processedCount || processedCount} ç­†è¨‚å–®ã€‚`);
                } else {
                    alert(result.message || 'å„²å­˜å¤±æ•—');
                }
            } catch (error) {
                console.error('é€±è¨‚å„²å­˜éŒ¯èª¤:', error);
                alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }


        // --- è¼‰å…¥æ­·å²è¨‚å–®åŠŸèƒ½ (å€é–“æŸ¥è©¢) - [ç¶­æŒä¸è®Š] ---
        function loadHistoryOrders() {
            if (!loggedInEmpId) return;

            const dateFromStr = document.getElementById('history-date-from').value;
            const dateToStr = document.getElementById('history-date-to').value;

            const resultDiv = document.getElementById('history-result');

            if (!dateFromStr || !dateToStr) {
                // å¦‚æœæ—¥æœŸå€é–“æœªè¨­å®šï¼Œå‰‡ä¸åŸ·è¡ŒæŸ¥è©¢ï¼Œé¿å…éŒ¯èª¤
                resultDiv.innerHTML = `<p style="color: #666;">è«‹è¼¸å…¥æ—¥æœŸå€é–“æˆ–ä½¿ç”¨å¿«æ·æŒ‰éˆ•æŸ¥è©¢ã€‚</p>`;
                return;
            }

            const dateFrom = new Date(dateFromStr + 'T00:00:00');
            const dateTo = new Date(dateToStr + 'T00:00:00');
            const orders = getOrders();
            let allRecords = [];

            if (dateFrom > dateTo) {
                resultDiv.innerHTML = `<p style="color: red;">èµ·å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸï¼</p>`;
                return;
            }

            let currentDate = new Date(dateFrom);
            while (currentDate <= dateTo) {
                const dateKey = formatDate(currentDate);
                const lunchKey = `${dateKey}_${loggedInEmpId}_LUNCH`;
                const dinnerKey = `${dateKey}_${loggedInEmpId}_DINNER`;

                if (orders[lunchKey] && orders[lunchKey].IsOrdered) {
                    allRecords.push({ dateKey, type: 'LUNCH', order: orders[lunchKey] });
                }
                if (orders[dinnerKey] && orders[dinnerKey].IsOrdered) {
                    allRecords.push({ dateKey, type: 'DINNER', order: orders[dinnerKey] });
                }

                currentDate.setDate(currentDate.getDate() + 1);
            }

            if (allRecords.length === 0) {
                resultDiv.innerHTML = `<p style="color: #999;">åœ¨ ${dateFromStr} è‡³ ${dateToStr} æœŸé–“æ²’æœ‰è¨‚è³¼ç´€éŒ„ã€‚</p>`;
            } else {
                let tableHTML = `
                    <h4>ç¸½å…±æŸ¥è©¢åˆ° ${allRecords.length} ç­†è¨‚å–®ã€‚è¨‚å–®æ˜ç´°:</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>è¨‚è³¼æ—¥æœŸ</th>
                                <th>é¤åˆ¥</th>
                                <th>é¤é»é¸é …</th>
                                <th>è¨‚è³¼æ™‚é–“</th>
                                <th>ç®¡ç†å“¡ä¿®æ”¹</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                allRecords.sort((a, b) => a.dateKey.localeCompare(b.dateKey));

                allRecords.forEach(item => {
                    const order = item.order;
                    const mealText = mealMap[item.type];
                    const optionText = `${dietMap[order.DietType]} (${riceMap[order.RicePortion]})`;
                    const adminModifiedText = order.AdminModified ? 'æ˜¯' : 'å¦';

                    tableHTML += `
                        <tr>
                            <td>${item.dateKey}</td>
                            <td>${mealText}</td>
                            <td>${optionText}</td>
                            <td>${order.OrderTime || 'N/A'}</td>
                            <td>${adminModifiedText}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;
                resultDiv.innerHTML = tableHTML;
            }
        }

        // åˆå§‹åŒ–
        updateTimeDisplay();
    </script>
</body>

</html>