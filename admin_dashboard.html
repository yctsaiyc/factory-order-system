<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤é»è¨‚è³¼ç³»çµ± - ç®¡ç†å“¡å¾Œå°</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* [START] å„€è¡¨æ¿æ¨£å¼ */
        /* [NEW] èª¿æ•´é é¢å¯¬åº¦ */
        .container {
            max-width: 1000px; /* å¢åŠ æœ€å¤§å¯¬åº¦ */
            margin: auto;
            padding: 20px;
        }         
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tab-menu {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 16px;
            font-weight: bold;
            color: #555;
            transition: color 0.2s;
            border-bottom: 3px solid transparent;
            white-space: nowrap; /* é˜²æ­¢æŒ‰éˆ•æ›è¡Œ */
        }
        .tab-button:hover {
            color: #007bff;
        }
        .tab-button.active {
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }
        .tab-content {
            display: none;
            padding: 15px 0;
        }
        .tab-content.active {
            display: block;
        }
        
        /* [UPDATED] CRUD è¡¨æ ¼æ¨£å¼ - å¢åŠ æ ¼ç·š */
        .master-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        .master-controls input, .master-controls select {
             padding: 8px;
             border: 1px solid #ccc;
             border-radius: 4px;
        }
        .master-table {
            width: 100%;
            border-collapse: collapse; /* åˆä½µé‚Šæ¡†ä»¥å½¢æˆæ ¼ç·š */
        }
        .master-table th, .master-table td {
            border: 1px solid #ccc; /* å¢åŠ æ ¼ç·š */
            padding: 8px; /* å¢åŠ å…§é‚Šè· */
            text-align: left;
        }
        .master-table th {
            background-color: #f0f0f0;
        }
        
        /* [UPDATED] èª¿æ•´å“¡å·¥ä¸»æª”è¡¨æ ¼æ¬„å¯¬ */
        #EmployeeMaster .master-table th:nth-child(2),
        #EmployeeMaster .master-table td:nth-child(2) { width: 100px; } /* å“¡å·¥ç·¨è™Ÿ */
        #EmployeeMaster .master-table th:nth-child(3),
        #EmployeeMaster .master-table td:nth-child(3) { width: 120px; } /* å“¡å·¥å§“å */
        #EmployeeMaster .master-table th:nth-child(4),
        #EmployeeMaster .master-table td:nth-child(4) { width: 100px; } /* å¯†ç¢¼ */
        #EmployeeMaster .master-table th:nth-child(5),
        #EmployeeMaster .master-table td:nth-child(5) { width: 100px; } /* éƒ¨é–€ä»£è™Ÿ */
        #EmployeeMaster .master-table th:nth-child(7),
        #EmployeeMaster .master-table td:nth-child(7) { width: 120px; } /* æ“ä½œ */

        /* [UPDATED] èª¿æ•´éƒ¨é–€ä¸»æª”è¡¨æ ¼æ¬„å¯¬ */
        #DeptMaster .master-table th:nth-child(2),
        #DeptMaster .master-table td:nth-child(2) { width: 120px; } /* éƒ¨é–€ä»£è™Ÿ */
        #DeptMaster .master-table th:nth-child(3),
        #DeptMaster .master-table td:nth-child(3) { width: 150px; } /* éƒ¨é–€åç¨± */
        #DeptMaster .master-table th:nth-child(4),
        #DeptMaster .master-table td:nth-child(4) { width: 100px; } /* æ“ä½œ1 */
        #DeptMaster .master-table th:nth-child(5),
        #DeptMaster .master-table td:nth-child(5) { width: 100px; } /* æ“ä½œ2 */

        /* [UPDATED] èª¿æ•´çª—å£ç¶­è­·è¡¨æ ¼æ¬„å¯¬ */
        #MealOrderWindowMaster .master-table th:nth-child(2),
        #MealOrderWindowMaster .master-table td:nth-child(2) { width: 100px; } /* å“¡å·¥ç·¨è™Ÿ */
        #MealOrderWindowMaster .master-table th:nth-child(3),
        #MealOrderWindowMaster .master-table td:nth-child(3) { width: 150px; } /* å“¡å·¥å§“å */
        #MealOrderWindowMaster .master-table th:nth-child(6),
        #MealOrderWindowMaster .master-table td:nth-child(6) { width: 120px; } /* æ“ä½œ */


        /* [END] å„€è¡¨æ¿æ¨£å¼ */

        /* åŸæœ‰çš„è¨‚å–®ç®¡ç†æ¨£å¼ */
        .admin-controls { padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; background-color: #f7f7f7; }
        .control-group { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .control-group label { font-weight: bold; white-space: nowrap; }
        .history-quick-buttons button { padding: 5px 10px; border: 1px solid #007bff; background-color: #fff; color: #007bff; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; margin-right: 5px; }
        .history-quick-buttons button:hover { background-color: #e6f7ff; }
        .date-input-group { display: flex; align-items: center; gap: 10px; }
        #employee-filter, #dept-filter { padding: 8px; border: 1px solid #ccc; border-radius: 5px; flex: 1; min-width: 150px;}
        .export-buttons-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .export-buttons-group button { flex-basis: calc(33.33% - 7px); min-width: 150px; padding: 10px 5px; }
        /* è¨‚å–®ç®¡ç†è¡¨æ ¼ - å¢åŠ æ ¼ç·š */
        #admin-table {
            width: 100%;
            border-collapse: collapse;
        }
        #admin-table th, #admin-table td {
            border: 1px solid #ccc; /* Add grid lines to admin table */
            padding: 8px;
        }
        #admin-table th { background-color: #007bff; color: white; }
    </style>
</head>
<body onload="checkAdminLogin()">
    <div class="container">
        <div class="admin-header">
            <h2>ğŸœ ç®¡ç†å“¡å¾Œå°ç³»çµ±</h2>
            <button class="btn btn-cancel" onclick="logout()" style="width: auto; padding: 5px 10px;">ç™»å‡º</button>
        </div>

        <div class="tab-menu">
            <button class="tab-button active" onclick="openTab(event, 'OrderManagement')">1. è¨‚å–®ç®¡ç†èˆ‡çµ±è¨ˆ</button>
            <button class="tab-button" onclick="openTab(event, 'DeptMaster')">2. éƒ¨é–€ä¸»æª”ç¶­è­·</button>
            <button class="tab-button" onclick="openTab(event, 'EmployeeMaster')">3. å“¡å·¥ä¸»æª”ç¶­è­·</button>
            <button class="tab-button" onclick="openTab(event, 'MealOrderWindowMaster')">4. è¨‚é¤çª—å£ç¶­è­·</button>
        </div>

        <div id="OrderManagement" class="tab-content active">
            <p id="admin-message" class="alert-danger">
                **è­¦å‘Š:** ç®¡ç†å“¡å°è¨‚å–®çš„ä¿®æ”¹**ä¸å— 09:30 é™åˆ¶**ï¼Œæ‰€æœ‰ä¿®æ”¹å°‡ç«‹å³ç”Ÿæ•ˆï¼Œä¸¦æ¨™è¨˜ç‚ºç®¡ç†å“¡æ“ä½œã€‚
            </p>

            <div class="admin-controls">
                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <div class="control-group" style="flex: 1; margin-bottom: 0;">
                        <label for="dept-filter">ç¯©é¸éƒ¨é–€:</label>
                        <select id="dept-filter" onchange="filterEmployeesByDept()"></select>
                    </div>
                    <div class="control-group" style="flex: 1; margin-bottom: 0;">
                        <label for="employee-filter">ç¯©é¸å“¡å·¥:</label>
                        <select id="employee-filter" onchange="loadOrders()"></select>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>å¿«æ·æŸ¥è©¢:</label>
                    <div class="history-quick-buttons">
                        <button onclick="setQuickRange('thisWeek')">æœ¬é€±</button>
                        <button onclick="setQuickRange('lastWeek')">ä¸Šé€±</button>
                        <button onclick="setQuickRange('thisMonth')">æœ¬æœˆ</button>
                        <button onclick="setQuickRange('lastMonth')">ä¸Šæœˆ</button>
                    </div>
                </div>
                <div class="control-group date-input-group">
                    <label for="order-date-from">æŸ¥è©¢å€é–“:</label>
                    <input type="date" id="order-date-from" style="flex: 1;">
                    <label for="order-date-to">è‡³:</label>
                    <input type="date" id="order-date-to" style="flex: 1;">
                    <button class="btn btn-order" style="width: auto;" onclick="loadOrders()">æŸ¥è©¢</button>
                </div>
                <div class="export-buttons-group">
                    <button class="btn btn-order" onclick="exportOrders()">åŒ¯å‡ºé¤é»ç¸½æ•¸é‡çµ±è¨ˆè¡¨</button>
                    <button class="btn btn-order" onclick="exportEmployeeStats()">åŒ¯å‡ºå“¡å·¥è¨‚è³¼æ•¸é‡çµ±è¨ˆè¡¨</button>
                    <button class="btn btn-order" onclick="exportDailyDetails()">åŒ¯å‡ºå“¡å·¥æ¯æ—¥è¨‚è³¼æ˜ç´°è¡¨</button>
                </div>
            </div>

            <h3>è¨‚å–®ç¸½è¦½èˆ‡ä¿®æ”¹ (<span id="query-summary">è«‹é¸æ“‡æ—¥æœŸå€é–“æŸ¥è©¢</span>)</h3>
            <table id="admin-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">æ—¥æœŸ</th>
                        <th style="width: 80px;">å“¡å·¥ID</th>
                        <th style="width: 80px;">å§“å</th>
                        <th style="width: 50px;">é¤åˆ¥</th>
                        <th style="width: 50px;">è‘·ç´ </th>
                        <th style="width: 50px;">é£¯é‡</th>
                        <th style="width: 80px;">ç®¡ç†å“¡ä¿®æ”¹?</th>
                        <th style="width: 80px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="order-list">
                    <tr><td colspan="8">è«‹è¨­å®šç¯©é¸æ¢ä»¶ä¸¦é»æ“ŠæŸ¥è©¢...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="DeptMaster" class="tab-content">
            <h3>ğŸ¢ éƒ¨é–€ä¸»æª”ç¶­è­· (CRUD)</h3>
            
            <div class="master-controls">
                <input type="hidden" id="dept-oid">
                <input type="text" id="dept-code" placeholder="éƒ¨é–€ä»£è™Ÿ" required>
                <input type="text" id="dept-name" placeholder="éƒ¨é–€åç¨±" required>
                <button class="btn btn-order" onclick="saveDept()">æ–°å¢/å„²å­˜</button>
                <button class="btn btn-cancel" onclick="clearDeptForm()">æ¸…ç©º</button>
            </div>

            <table class="master-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">OID</th>
                        <th>éƒ¨é–€ä»£è™Ÿ</th>
                        <th>éƒ¨é–€åç¨±</th>
                        <th colspan="2">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="dept-list">
                    </tbody>
            </table>
        </div>

        <div id="EmployeeMaster" class="tab-content">
            <h3>ğŸ‘¤ å“¡å·¥ä¸»æª”ç¶­è­· (CRUD)</h3>

            <div class="master-controls" style="flex-wrap: wrap;">
                <input type="hidden" id="emp-oid">
                
                <input type="text" id="emp-id" placeholder="å“¡å·¥ç·¨è™Ÿ" required style="flex: 1;">
                <input type="text" id="emp-name" placeholder="å“¡å·¥å§“å" required style="flex: 1;">
                <input type="password" id="emp-password" placeholder="å¯†ç¢¼" required style="flex: 1;">
                
                <label for="emp-dept-select" style="font-weight: normal;">éƒ¨é–€:</label>
                <select id="emp-dept-select" style="flex: 1;"></select>
                
                <button class="btn btn-order" onclick="saveEmployee()">æ–°å¢/å„²å­˜</button>
                <button class="btn btn-cancel" onclick="clearEmployeeForm()">æ¸…ç©º</button>
            </div>

            <table class="master-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">OID</th>
                        <th>å“¡å·¥ç·¨è™Ÿ</th>
                        <th>å“¡å·¥å§“å</th>
                        <th>å¯†ç¢¼ (åƒ…é•·åº¦)</th>
                        <th>éƒ¨é–€ä»£è™Ÿ</th>
                        <th style="width: auto;">éƒ¨é–€åç¨±</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="employee-list">
                    </tbody>
            </table>
        </div>
        
        <div id="MealOrderWindowMaster" class="tab-content">
            <h3>ğŸ§‘â€ğŸ’» è¨‚é¤çª—å£ç¶­è­· (CRUD)</h3>

            <div class="master-controls" style="flex-wrap: wrap; align-items: flex-start;">
                <input type="hidden" id="window-oid">
                
                <label for="window-emp-select" style="font-weight: normal; margin-right: 10px;">çª—å£å“¡å·¥:</label>
                <select id="window-emp-select" style="flex: 1; min-width: 150px; margin-bottom: 10px;"></select>
                
                <div style="width: 100%; margin-bottom: 10px;">
                    <label style="font-weight: normal; margin-right: 10px;">è² è²¬å–®ä½ (å¯è¤‡é¸):</label>
                    <div id="window-dept-checkboxes" style="display: flex; flex-wrap: wrap; gap: 10px; border: 1px solid #ccc; padding: 10px; border-radius: 4px; background-color: #fff;">
                        </div>
                </div>
                
                <button class="btn btn-order" onclick="saveWindow()">æ–°å¢/å„²å­˜</button>
                <button class="btn btn-cancel" onclick="clearWindowForm()">æ¸…ç©º</button>
            </div>

            <table class="master-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">OID</th>
                        <th>å“¡å·¥ç·¨è™Ÿ</th>
                        <th>å“¡å·¥å§“å</th>
                        <th>è² è²¬éƒ¨é–€ä»£è™Ÿ</th>
                        <th>è² è²¬éƒ¨é–€åç¨±</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="window-list">
                    </tbody>
            </table>
        </div>

        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ä¿®æ”¹è¨‚å–®</h3>
                    <span class="close" onclick="closeEditModal()">&times;</span>
                </div>
                <div id="edit-form">
                    <p>å“¡å·¥: <strong id="edit-emp-info"></strong></p>
                    <p>é¤åˆ¥: <strong id="edit-meal-type"></strong></p>
                    
                    <div class="option-group">
                        <label>è‘·ç´ :</label>
                        <input type="radio" id="edit-diet-meat" name="edit-diet" value="MEAT"> è‘·é£Ÿ
                        <input type="radio" id="edit-diet-veg" name="edit-diet" value="VEG"> ç´ é£Ÿ
                    </div>
    
                    <div class="option-group">
                        <label>é£¯é‡:</label>
                        <input type="radio" id="edit-rice-full" name="edit-rice" value="FULL"> å…¨é£¯
                        <input type="radio" id="edit-rice-half" name="edit-rice" value="HALF"> åŠé£¯
                    </div>

                    <p>æ˜¯å¦å–æ¶ˆè¨‚å–® (è¨­ç‚ºæœªè¨‚è³¼): <input type="checkbox" id="edit-is-ordered"></p>
    
                    <button class="btn btn-order" onclick="saveEdit()">ç¢ºèªä¿®æ”¹</button>
                    <input type="hidden" id="edit-order-key">
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global for filtering/permissions - simplified for development
        let currentViewableDeptCodes = [];
        let isAdmin = false;

        // åˆå§‹åŒ–æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        function checkAdminLogin() {
            if (sessionStorage.getItem('isAdminLoggedIn') !== 'true') {
                window.location.href = 'admin_login.html';
            }
            // åˆå§‹åŒ–éƒ¨é–€ã€å“¡å·¥å’Œçª—å£ä¸»æª”è³‡æ–™
            loadDeptData();
            loadEmployeeData();
            loadWindowData(); // NEW: Load the new Window Master Data

            // åˆå§‹åŒ–è¨‚å–®ç®¡ç†ç¯©é¸å™¨ï¼Œä¸¦è¼‰å…¥åˆå§‹è¨‚å–®
            loadFilters(); // NEW function to handle dept/employee filter based on role
            
            // ä½¿ç”¨å¿«æ·æŸ¥è©¢è¼‰å…¥åˆå§‹è³‡æ–™
            setQuickRange('thisMonth');
        }

        // --- é ç±¤åˆ‡æ›é‚è¼¯ ---
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            // å¦‚æœåˆ‡æ›åˆ°ä¸»æª”ç¶­è­·é ç±¤ï¼Œé‡æ–°è¼‰å…¥è³‡æ–™
            if (tabName === 'DeptMaster') loadDeptData();
            if (tabName === 'EmployeeMaster') loadEmployeeData();
            if (tabName === 'MealOrderWindowMaster') loadWindowData(); // NEW
        }


        // --- æ ¸å¿ƒè®Šæ•¸èˆ‡è¼”åŠ©å‡½å¼ (å¾ä¸Šå‚³æª”æ¡ˆèª¿æ•´) ---
        // ç‚ºäº†ç¶­æŒåŸæœ‰æœªä¿®æ”¹çš„å‡½å¼çš„å…¼å®¹æ€§ï¼Œç‰¹åˆ¥æ˜¯ export... å‡½å¼
        const employeeData = getMasterEmployees().reduce((map, emp) => {
            map[emp.EmpID] = emp.EmpName;
            return map;
        }, {});
        
        const mealMap = { LUNCH: 'åˆé¤', DINNER: 'æ™šé¤' };
        const dietMap = { MEAT: 'è‘·é£Ÿ', VEG: 'ç´ é£Ÿ' };
        const riceMap = { FULL: 'å…¨é£¯', HALF: 'åŠé£¯' };

        function getOrders() {
            return JSON.parse(localStorage.getItem('mealOrders')) || {};
        }
        function saveOrders(orders) {
            localStorage.setItem('mealOrders', JSON.stringify(orders));
        }
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        function logout() {
            sessionStorage.removeItem('isAdminLoggedIn');
            window.location.href = 'admin_login.html'; 
        }

        // --- 2. éƒ¨é–€ä¸»æª”ç¶­è­· (CRUD) é‚è¼¯ ---
        function getMasterDepts() {
            // é è¨­ä¸€äº›éƒ¨é–€æ•¸æ“š
            const defaultDepts = [
                { OID: 1, DeptCode: 'A10', DeptName: 'ç”Ÿç”¢éƒ¨' },
                { OID: 2, DeptCode: 'B20', DeptName: 'å€‰å„²éƒ¨' },
                { OID: 3, DeptCode: 'C30', DeptName: 'è¡Œæ”¿éƒ¨' }
            ];
            return JSON.parse(localStorage.getItem('masterDepts')) || defaultDepts;
        }

        function saveMasterDepts(depts) {
            localStorage.setItem('masterDepts', JSON.stringify(depts));
            // éƒ¨é–€æ›´æ–°æ™‚ï¼Œéœ€è¦é‡æ–°è¼‰å…¥ç¯©é¸å™¨
            if (document.getElementById('dept-filter')) loadFilters(); 
            if (document.getElementById('window-list')) loadWindowData(); 
        }

        function loadDeptData() {
            const depts = getMasterDepts();
            const listBody = document.getElementById('dept-list');
            listBody.innerHTML = '';
            
            depts.sort((a, b) => a.DeptCode.localeCompare(b.DeptCode));

            depts.forEach(dept => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${dept.OID}</td>
                    <td>${dept.DeptCode}</td>
                    <td>${dept.DeptName}</td>
                    <td><button class="btn btn-order" style="padding: 4px 6px;" onclick="editDept(${dept.OID})">ç·¨è¼¯</button></td>             
                    <td><button class="btn btn-cancel" style="padding: 4px 6px;" onclick="deleteDept(${dept.OID})">åˆªé™¤</button></td>    
                `;
                listBody.appendChild(tr);
            });
            // éƒ¨é–€ä¸»æª”æ›´æ–°æ™‚ï¼ŒåŒæ­¥æ›´æ–°å“¡å·¥ç¶­è­·é ç±¤çš„ä¸‹æ‹‰é¸å–®
            updateEmployeeDeptSelect(depts);
        }
        
        function clearDeptForm() {
            document.getElementById('dept-oid').value = '';
            document.getElementById('dept-code').value = '';
            document.getElementById('dept-name').value = '';
        }

        function saveDept() {
            let depts = getMasterDepts();
            const oid = document.getElementById('dept-oid').value;
            const code = document.getElementById('dept-code').value.trim().toUpperCase();
            const name = document.getElementById('dept-name').value.trim();

            if (!code || !name) {
                alert('éƒ¨é–€ä»£è™Ÿå’Œéƒ¨é–€åç¨±ä¸èƒ½ç‚ºç©ºï¼');
                return;
            }

            if (oid) {
                // ä¿®æ”¹ç¾æœ‰éƒ¨é–€
                const index = depts.findIndex(d => d.OID == oid);
                if (index > -1) {
                    // æª¢æŸ¥ä¿®æ”¹å¾Œçš„ä»£è™Ÿæ˜¯å¦èˆ‡å…¶ä»–éƒ¨é–€ä»£è™Ÿè¡çª
                    if (depts.some(d => d.DeptCode === code && d.OID != oid)) {
                        alert('éƒ¨é–€ä»£è™Ÿå·²å­˜åœ¨ï¼');
                        return;
                    }
                    depts[index].DeptCode = code;
                    depts[index].DeptName = name;
                }
            } else {
                // æ–°å¢éƒ¨é–€
                if (depts.some(d => d.DeptCode === code)) {
                    alert('éƒ¨é–€ä»£è™Ÿå·²å­˜åœ¨ï¼');
                    return;
                }
                const newOID = depts.length > 0 ? Math.max(...depts.map(d => d.OID)) + 1 : 1;
                depts.push({ OID: newOID, DeptCode: code, DeptName: name });
            }

            saveMasterDepts(depts);
            clearDeptForm();
            loadDeptData();
            alert('éƒ¨é–€è³‡æ–™å„²å­˜æˆåŠŸï¼');
        }

        function editDept(oid) {
            const depts = getMasterDepts();
            const dept = depts.find(d => d.OID === oid);
            if (dept) {
                document.getElementById('dept-oid').value = dept.OID;
                document.getElementById('dept-code').value = dept.DeptCode;
                document.getElementById('dept-name').value = dept.DeptName;
            }
        }

        function deleteDept(oid) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤éƒ¨é–€å—ï¼Ÿæ‰€æœ‰é—œè¯çš„å“¡å·¥è³‡æ–™å¯èƒ½éœ€è¦æ‰‹å‹•æ›´æ–°ã€‚')) return;
            let depts = getMasterDepts().filter(d => d.OID !== oid);
            saveMasterDepts(depts);
            loadDeptData();
            alert('éƒ¨é–€è³‡æ–™åˆªé™¤æˆåŠŸï¼');
        }


        // --- 3. å“¡å·¥ä¸»æª”ç¶­è­· (CRUD) é‚è¼¯ ---
        function getMasterEmployees() {
            // é è¨­å“¡å·¥æ•¸æ“š
            const defaultEmps = [
                { OID: 101, DeptCode: 'A10', DeptName: 'ç”Ÿç”¢éƒ¨', EmpID: '93800', EmpName: 'æ—æ·‘éˆº', Password: '1234' },
                { OID: 102, DeptCode: 'B20', DeptName: 'å€‰å„²éƒ¨', EmpID: '28109', EmpName: 'è©¹é‡‘ç’‹', Password: '1234' },
                { OID: 103, DeptCode: 'C30', DeptName: 'è¡Œæ”¿éƒ¨', EmpID: '2400305', EmpName: 'ç‹ç€šç« ', Password: '1234' }
            ];
            return JSON.parse(localStorage.getItem('masterEmployees')) || defaultEmps;
        }

        function saveMasterEmployees(employees) {
            localStorage.setItem('masterEmployees', JSON.stringify(employees));
            // åŒæ­¥æ›´æ–°è¨‚å–®ç®¡ç†çš„ç¯©é¸å™¨
            loadFilters(); 
            // åŒæ­¥æ›´æ–°çª—å£ç¶­è­·çš„å“¡å·¥åˆ—è¡¨
            if (document.getElementById('window-list')) loadWindowData(); 
        }

        function updateEmployeeDeptSelect(depts) {
            const select = document.getElementById('emp-dept-select');
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡éƒ¨é–€ --</option>';
            depts.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.DeptCode;
                option.textContent = `${dept.DeptCode} - ${dept.DeptName}`;
                option.setAttribute('data-name', dept.DeptName);
                select.appendChild(option);
            });
        }

        function loadEmployeeData() {
            const employees = getMasterEmployees();
            const depts = getMasterDepts(); // å–å¾—éƒ¨é–€è³‡æ–™ç”¨æ–¼é¡¯ç¤º
            const listBody = document.getElementById('employee-list');
            listBody.innerHTML = '';

            employees.sort((a, b) => a.EmpID.localeCompare(b.EmpID));

            employees.forEach(emp => {
                const deptInfo = depts.find(d => d.DeptCode === emp.DeptCode) || { DeptName: 'æœªçŸ¥', DeptCode: 'N/A' };
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${emp.OID}</td>
                    <td>${emp.EmpID}</td>
                    <td>${emp.EmpName}</td>
                    <td>${'â€¢'.repeat(emp.Password ? emp.Password.length : 0)}</td>
                    <td>${deptInfo.DeptCode}</td>
                    <td>${deptInfo.DeptName}</td>
                    <td>
                        <button class="btn btn-order" style="padding: 5px 8px;" onclick="editEmployee(${emp.OID})">ç·¨è¼¯</button>
                        <button class="btn btn-cancel" style="padding: 5px 8px;" onclick="deleteEmployee(${emp.OID})">åˆªé™¤</button>
                    </td>
                `;
                listBody.appendChild(tr);
            });
            updateEmployeeDeptSelect(depts);
        }
        
        function clearEmployeeForm() {
            document.getElementById('emp-oid').value = '';
            document.getElementById('emp-id').value = '';
            document.getElementById('emp-name').value = '';
            document.getElementById('emp-password').value = '';
            document.getElementById('emp-dept-select').value = '';
        }

        function saveEmployee() {
            let employees = getMasterEmployees();
            const depts = getMasterDepts();
            const oid = document.getElementById('emp-oid').value;
            const empId = document.getElementById('emp-id').value.trim().toUpperCase();
            const empName = document.getElementById('emp-name').value.trim();
            const password = document.getElementById('emp-password').value;
            const deptCode = document.getElementById('emp-dept-select').value;
            
            if (!empId || !empName || !password || !deptCode) {
                alert('å“¡å·¥ç·¨è™Ÿã€å§“åã€å¯†ç¢¼å’Œéƒ¨é–€éƒ½ä¸èƒ½ç‚ºç©ºï¼');
                return;
            }

            const selectedDept = depts.find(d => d.DeptCode === deptCode);
            const deptName = selectedDept ? selectedDept.DeptName : 'æœªçŸ¥';

            if (oid) {
                // ä¿®æ”¹ç¾æœ‰å“¡å·¥
                const index = employees.findIndex(e => e.OID == oid);
                if (index > -1) {
                    // æª¢æŸ¥ä¿®æ”¹å¾Œçš„å“¡å·¥ç·¨è™Ÿæ˜¯å¦èˆ‡å…¶ä»–å“¡å·¥ç·¨è™Ÿè¡çª
                    if (employees.some(e => e.EmpID === empId && e.OID != oid)) {
                        alert('å“¡å·¥ç·¨è™Ÿå·²å­˜åœ¨ï¼');
                        return;
                    }
                    employees[index].EmpID = empId;
                    employees[index].EmpName = empName;
                    employees[index].Password = password;
                    employees[index].DeptCode = deptCode;
                    employees[index].DeptName = deptName;
                }
            } else {
                // æ–°å¢å“¡å·¥
                if (employees.some(e => e.EmpID === empId)) {
                    alert('å“¡å·¥ç·¨è™Ÿå·²å­˜åœ¨ï¼');
                    return;
                }
                const newOID = employees.length > 0 ? Math.max(...employees.map(e => e.OID)) + 1 : 101;
                employees.push({ OID: newOID, DeptCode: deptCode, DeptName: deptName, EmpID: empId, EmpName: empName, Password: password });
            }

            saveMasterEmployees(employees);
            clearEmployeeForm();
            loadEmployeeData();
            alert('å“¡å·¥è³‡æ–™å„²å­˜æˆåŠŸï¼');
        }

        function editEmployee(oid) {
            const employees = getMasterEmployees();
            const emp = employees.find(e => e.OID === oid);
            if (emp) {
                document.getElementById('emp-oid').value = emp.OID;
                document.getElementById('emp-id').value = emp.EmpID;
                document.getElementById('emp-name').value = emp.EmpName;
                document.getElementById('emp-password').value = emp.Password; // è¼‰å…¥å¯†ç¢¼åŸå§‹å€¼
                document.getElementById('emp-dept-select').value = emp.DeptCode;
            }
        }

        function deleteEmployee(oid) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å“¡å·¥å—ï¼Ÿ')) return;
            let employees = getMasterEmployees().filter(e => e.OID !== oid);
            saveMasterEmployees(employees);
            loadEmployeeData();
            alert('å“¡å·¥è³‡æ–™åˆªé™¤æˆåŠŸï¼');
        }

        // --- 4. è¨‚é¤çª—å£ç¶­è­· (CRUD) é‚è¼¯ ---
        function getMasterWindows() {
            // é è¨­ä¸€å€‹çª—å£æ•¸æ“š (è©¹é‡‘ç’‹ 28109 è² è²¬ A10 ç”Ÿç”¢éƒ¨, C30 è¡Œæ”¿éƒ¨)
            const defaultWindows = [
                { OID: 1, EmpID: '28109', ResponsibleDeptCodes: ['A10', 'C30'] }
            ];
            return JSON.parse(localStorage.getItem('masterWindows')) || defaultWindows;
        }

        function saveMasterWindows(windows) {
            localStorage.setItem('masterWindows', JSON.stringify(windows));
            // çª—å£è³‡æ–™è®Šæ›´æ™‚ï¼Œéœ€è¦é‡æ–°è¼‰å…¥ç¯©é¸å™¨
            if (document.getElementById('dept-filter')) loadFilters(); 
        }
        
        function updateWindowDeptCheckboxes(depts, responsibleCodes = []) {
            const container = document.getElementById('window-dept-checkboxes');
            container.innerHTML = '';
            depts.sort((a, b) => a.DeptCode.localeCompare(b.DeptCode)).forEach(dept => {
                const isChecked = responsibleCodes.includes(dept.DeptCode);
                container.innerHTML += `
                    <div style="white-space: nowrap;">
                        <input type="checkbox" id="dept-check-${dept.DeptCode}" value="${dept.DeptCode}" ${isChecked ? 'checked' : ''}>
                        <label for="dept-check-${dept.DeptCode}">${dept.DeptCode} - ${dept.DeptName}</label>
                    </div>
                `;
            });
        }

        function updateWindowEmployeeSelect(employees) {
            const select = document.getElementById('window-emp-select');
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡çª—å£å“¡å·¥ --</option>';
            employees.sort((a, b) => a.EmpID.localeCompare(b.EmpID)).forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.EmpID;
                option.textContent = `${emp.EmpID} - ${emp.EmpName} (${emp.DeptCode})`;
                select.appendChild(option);
            });
        }

        function loadWindowData() {
            const windows = getMasterWindows();
            const employees = getMasterEmployees();
            const depts = getMasterDepts();
            const listBody = document.getElementById('window-list');
            listBody.innerHTML = '';
            
            // Populate the dropdown and checkboxes for the form
            updateWindowEmployeeSelect(employees);
            updateWindowDeptCheckboxes(depts); // Empty selection for initial form

            windows.sort((a, b) => a.EmpID.localeCompare(b.EmpID));

            windows.forEach(win => {
                const empInfo = employees.find(e => e.EmpID === win.EmpID) || { EmpName: 'æœªçŸ¥å“¡å·¥', DeptCode: 'N/A' };
                
                const deptNames = win.ResponsibleDeptCodes.map(code => {
                    const dept = depts.find(d => d.DeptCode === code);
                    return dept ? dept.DeptName : `æœªçŸ¥(${code})`;
                });
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${win.OID}</td>
                    <td>${win.EmpID}</td>
                    <td>${empInfo.EmpName}</td>
                    <td>${win.ResponsibleDeptCodes.join('<br>')}</td>
                    <td>${deptNames.join('<br>')}</td>
                    <td>
                        <button class="btn btn-order" style="padding: 5px 8px;" onclick="editWindow(${win.OID})">ç·¨è¼¯</button>
                        <button class="btn btn-cancel" style="padding: 5px 8px;" onclick="deleteWindow(${win.OID})">åˆªé™¤</button>
                    </td>
                `;
                listBody.appendChild(tr);
            });
        }

        function clearWindowForm() {
            document.getElementById('window-oid').value = '';
            document.getElementById('window-emp-select').value = '';
            const depts = getMasterDepts();
            updateWindowDeptCheckboxes(depts); // Reset checkboxes
        }

        function saveWindow() {
            let windows = getMasterWindows();
            const oid = document.getElementById('window-oid').value;
            const empId = document.getElementById('window-emp-select').value;
            const deptCheckboxes = document.querySelectorAll('#window-dept-checkboxes input[type="checkbox"]:checked');
            const responsibleDeptCodes = Array.from(deptCheckboxes).map(cb => cb.value);

            if (!empId) {
                alert('è«‹é¸æ“‡ä¸€å€‹çª—å£å“¡å·¥ï¼');
                return;
            }

            if (windows.some(w => w.EmpID === empId && w.OID != oid)) {
                alert('è©²å“¡å·¥å·²ç¶“æ˜¯è¨‚é¤çª—å£ï¼è«‹ä½¿ç”¨ç·¨è¼¯åŠŸèƒ½ä¿®æ”¹ã€‚');
                return;
            }

            if (responsibleDeptCodes.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è² è²¬å–®ä½ï¼');
                return;
            }

            if (oid) {
                // ä¿®æ”¹ç¾æœ‰çª—å£
                const index = windows.findIndex(w => w.OID == oid);
                if (index > -1) {
                    windows[index].EmpID = empId;
                    windows[index].ResponsibleDeptCodes = responsibleDeptCodes;
                }
            } else {
                // æ–°å¢çª—å£
                const newOID = windows.length > 0 ? Math.max(...windows.map(w => w.OID)) + 1 : 1;
                windows.push({ OID: newOID, EmpID: empId, ResponsibleDeptCodes: responsibleDeptCodes });
            }

            saveMasterWindows(windows);
            clearWindowForm();
            loadWindowData();
            alert('è¨‚é¤çª—å£è³‡æ–™å„²å­˜æˆåŠŸï¼');
        }

        function editWindow(oid) {
            const windows = getMasterWindows();
            const depts = getMasterDepts();
            const win = windows.find(w => w.OID === oid);
            if (win) {
                document.getElementById('window-oid').value = win.OID;
                document.getElementById('window-emp-select').value = win.EmpID;
                updateWindowDeptCheckboxes(depts, win.ResponsibleDeptCodes);
            }
        }

        function deleteWindow(oid) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨‚é¤çª—å£è¨­å®šå—ï¼Ÿ')) return;
            let windows = getMasterWindows().filter(w => w.OID !== oid);
            saveMasterWindows(windows);
            loadWindowData();
            alert('è¨‚é¤çª—å£è³‡æ–™åˆªé™¤æˆåŠŸï¼');
        }
        
        // --- 1. è¨‚å–®ç®¡ç†ç¯©é¸é‚è¼¯ ---

        function loadFilters() {
            const isUserAdmin = sessionStorage.getItem('isAdminLoggedIn') === 'true';
            isAdmin = isUserAdmin;
            const allEmployees = getMasterEmployees();
            const allDepts = getMasterDepts();
            const allWindows = getMasterWindows();
            
            // *** é€™æ˜¯ç®¡ç†å“¡å¾Œå°ï¼Œç›®å‰å‡è¨­åªæœ‰ Admin ç™»å…¥ï¼Œæ‰€ä»¥ Admin çœ‹åˆ°æ‰€æœ‰éƒ¨é–€ã€‚
            // *** æœªä¾†å¦‚æœéœ€è¦å€åˆ†ç™»å…¥è€…ï¼Œæ­¤è™•æ‡‰ä½¿ç”¨å¯¦éš› logged-in EmpID ä¾†æŸ¥æ‰¾å…¶è² è²¬éƒ¨é–€ã€‚
            
            let viewableDepts = allDepts; // Admin sees all
            let loggedInEmpID = ''; // Placeholder for real system

            if (!isUserAdmin && loggedInEmpID) { 
                 const windowInfo = allWindows.find(w => w.EmpID === loggedInEmpID);
                 if (windowInfo) {
                     viewableDepts = allDepts.filter(d => windowInfo.ResponsibleDeptCodes.includes(d.DeptCode));
                 } else {
                     viewableDepts = []; // Not an admin and not a window, see nothing
                 }
            }
            
            // Set global viewable department codes
            currentViewableDeptCodes = viewableDepts.map(d => d.DeptCode);
            
            // 1. Populate Department Filter
            const deptFilter = document.getElementById('dept-filter');
            deptFilter.innerHTML = `<option value="ALL_RESPONSIBLE">${isAdmin ? 'æ‰€æœ‰å–®ä½ (ç®¡ç†å“¡)' : 'è² è²¬å–®ä½å…¨éƒ¨'}</option>`;
            
            viewableDepts.sort((a, b) => a.DeptCode.localeCompare(b.DeptCode)).forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.DeptCode;
                option.textContent = `${dept.DeptCode} - ${dept.DeptName}`;
                deptFilter.appendChild(option);
            });

            // 2. Populate Employee Filter (Trigger the linked function)
            filterEmployeesByDept();
        }

        function filterEmployeesByDept() {
            const deptCode = document.getElementById('dept-filter').value;
            const employeeFilter = document.getElementById('employee-filter');
            const allEmployees = getMasterEmployees();
            
            // Determine the departments whose employees should be shown
            const deptsToFilter = (deptCode === 'ALL_RESPONSIBLE') ? currentViewableDeptCodes : [deptCode];

            employeeFilter.innerHTML = '<option value="ALL">æ‰€æœ‰å“¡å·¥</option>';
            
            const filteredEmployees = allEmployees
                .filter(emp => deptsToFilter.includes(emp.DeptCode))
                .sort((a, b) => a.EmpID.localeCompare(b.EmpID));

            filteredEmployees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.EmpID;
                option.textContent = `${emp.EmpID} - ${emp.EmpName} (${emp.DeptCode})`;
                employeeFilter.appendChild(option);
            });

            loadOrders(); // Reload orders whenever department/employee filter changes
        }

        function loadOrders() {
            const dateFromStr = document.getElementById('order-date-from').value;
            const dateToStr = document.getElementById('order-date-to').value;
            const selectedDeptCode = document.getElementById('dept-filter').value;
            const selectedEmpId = document.getElementById('employee-filter').value;
            
            if (!dateFromStr || !dateToStr) {
                document.getElementById('order-list').innerHTML = '<tr><td colspan="8">è«‹è¨­å®šç¯©é¸æ¢ä»¶ä¸¦é»æ“ŠæŸ¥è©¢...</td></tr>';
                document.getElementById('query-summary').textContent = 'è«‹é¸æ“‡æ—¥æœŸå€é–“æŸ¥è©¢';
                return;
            }

            const dateFrom = new Date(dateFromStr + 'T00:00:00');
            const dateTo = new Date(dateToStr + 'T00:00:00');
            const allOrders = getOrders();
            const currentEmployees = getMasterEmployees(); 
            const employeeMap = currentEmployees.reduce((map, emp) => {
                map[emp.EmpID] = { EmpName: emp.EmpName, DeptCode: emp.DeptCode };
                return map;
            }, {});

            const orderList = document.getElementById('order-list');
            orderList.innerHTML = '';
            let filteredOrders = [];

            if (dateFrom > dateTo) {
                orderList.innerHTML = `<tr><td colspan="8" style="color: red;">èµ·å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸï¼</td></tr>`;
                return;
            }

            // Determine the departments to include in the order list (based on filter selection AND user's viewable departments)
            let allowedDeptCodes = (selectedDeptCode === 'ALL_RESPONSIBLE') ? currentViewableDeptCodes : [selectedDeptCode];
            
            let currentDate = new Date(dateFrom);
            while (currentDate <= dateTo) {
                const dateKey = formatDate(currentDate);
                
                for (const key in allOrders) {
                    const order = allOrders[key];
                    const [orderDate, empId, mealType] = key.split('_');

                    if (orderDate === dateKey) {
                        const empInfo = employeeMap[empId];
                        if (!empInfo) continue; 

                        // 1. Department Filter check: must be in the allowed department list
                        const deptMatch = allowedDeptCodes.includes(empInfo.DeptCode);
                        
                        // 2. Employee Filter check: must be ALL or the selected EmpID
                        const empMatch = (selectedEmpId === 'ALL' || selectedEmpId === empId);

                        // 3. Must be an ordered item
                        if (order.IsOrdered && deptMatch && empMatch) {
                            filteredOrders.push({ key, order, dateKey, EmpName: empInfo.EmpName });
                        }
                    }
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            if (filteredOrders.length === 0) {
                orderList.innerHTML = `<tr><td colspan="8">åœ¨é¸æ“‡çš„å€é–“å’Œæ¢ä»¶ä¸‹æ²’æœ‰è¨‚å–®è¨˜éŒ„ã€‚</td></tr>`;
            } else {
                filteredOrders.forEach(item => {
                    const order = item.order;
                    const empName = item.EmpName; 
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.dateKey}</td>
                        <td>${order.EmpID}</td>
                        <td>${empName}</td>
                        <td>${mealMap[order.MealType]}</td>
                        <td>${dietMap[order.DietType]}</td>
                        <td>${riceMap[order.RicePortion]}</td>
                        <td>${order.AdminModified ? 'âœ… æ˜¯' : 'âŒ å¦'}</td>
                        <td><button class="btn btn-order" style="width: auto; padding: 5px 8px;" onclick="openEditModal('${item.key}')">ä¿®æ”¹</button></td>
                    `;
                    orderList.appendChild(tr);
                });
            }
            
            const selectedDeptName = document.getElementById('dept-filter').options[document.getElementById('dept-filter').selectedIndex].textContent;
            const selectedEmpName = document.getElementById('employee-filter').options[document.getElementById('employee-filter').selectedIndex].textContent;

            document.getElementById('query-summary').textContent = 
                `${dateFromStr} ~ ${dateToStr}ï¼Œéƒ¨é–€: ${selectedDeptName}ï¼Œå“¡å·¥: ${selectedEmpName}ï¼Œå…± ${filteredOrders.length} ç­†è¨‚å–®`;
        }

        // --- å¿«æ·æ—¥æœŸå€é–“è¨­å®š (ä¿æŒä¸è®Š) ---
        function setQuickRange(period) {
            const today = new Date();
            let startDate, endDate;

            switch (period) {
                case 'thisWeek': 
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay()); 
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                case 'lastWeek': 
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay() - 7);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                case 'thisMonth': 
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'lastMonth': 
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                default:
                    return;
            }

            document.getElementById('order-date-from').value = formatDate(startDate);
            document.getElementById('order-date-to').value = formatDate(endDate);
            loadOrders(); 
        }

        // --- ä¿®æ”¹ Modal é‚è¼¯ (ä¿æŒä¸è®Š) ---
        function openEditModal(key) {
            const allOrders = getOrders();
            const order = allOrders[key];

            if (!order) {
                alert('æ‰¾ä¸åˆ°è©²ç­†è¨‚å–®ï¼');
                return;
            }
            
            // ä½¿ç”¨ getMasterEmployees ç¢ºä¿æœ€æ–°çš„å“¡å·¥å§“å
            const empInfo = getMasterEmployees().find(e => e.EmpID === order.EmpID) || { EmpName: 'æœªçŸ¥' };

            document.getElementById('edit-order-key').value = key;
            document.getElementById('edit-emp-info').textContent = `${order.EmpID} (${empInfo.EmpName})`;
            document.getElementById('edit-meal-type').textContent = order.MealType === 'LUNCH' ? 'åˆé¤' : 'æ™šé¤';
            
            document.getElementById(`edit-diet-${order.DietType.toLowerCase()}`).checked = true;
            document.getElementById(`edit-rice-${order.RicePortion.toLowerCase()}`).checked = true;
            document.getElementById('edit-is-ordered').checked = !order.IsOrdered;

            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function saveEdit() {
            const key = document.getElementById('edit-order-key').value;
            const allOrders = getOrders();
            const order = allOrders[key];

            if (!order) {
                alert('è¨‚å–®è³‡æ–™éºå¤±ï¼Œç„¡æ³•ä¿®æ”¹ï¼');
                return;
            }

            const newDiet = document.querySelector('input[name="edit-diet"]:checked').value;
            const newRice = document.querySelector('input[name="edit-rice"]:checked').value;
            const isCancelled = document.getElementById('edit-is-ordered').checked;

            order.DietType = newDiet;
            order.RicePortion = newRice;
            order.IsOrdered = !isCancelled;
            order.AdminModified = true;

            if (!order.IsOrdered) {
                delete allOrders[key];
                alert('è¨‚å–®å·²ç”±ç®¡ç†å“¡æˆåŠŸå–æ¶ˆã€‚');
            } else {
                allOrders[key] = order;
                alert('è¨‚å–®å·²ç”±ç®¡ç†å“¡æˆåŠŸä¿®æ”¹ï¼');
            }
            
            saveOrders(allOrders);
            closeEditModal();
            loadOrders();
        }


        // --- åŒ¯å‡ºåŠŸèƒ½ (ä¿æŒä¸è®Šï¼Œä½†è«‹æ³¨æ„å®ƒå€‘æ‡‰ä½¿ç”¨æœ€æ–°çš„å“¡å·¥è³‡æ–™æˆ–ç¯©é¸é‚è¼¯ä¾†èª¿æ•´) ---
        // ç”±æ–¼ç¯‡å¹…é™åˆ¶ï¼ŒåŒ¯å‡ºå‡½å¼ç¶­æŒåŸæ¨£ã€‚åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼ŒexportEmployeeStats/exportDailyDetails æ‡‰ä½¿ç”¨ getMasterEmployees ä¾†ç²å–æœ€æ–°çš„å“¡å·¥åˆ—è¡¨ã€‚

        // --- 1. åŒ¯å‡ºé¤é»ç¸½æ•¸é‡çµ±è¨ˆè¡¨ (ç¶­æŒä¸è®Š) ---
        function exportOrders() {
            const dateFromStr = document.getElementById('order-date-from').value;
            const dateToStr = document.getElementById('order-date-to').value;
            
            if (!dateFromStr || !dateToStr) {
                alert('è«‹å…ˆé¸æ“‡å®Œæ•´çš„æ—¥æœŸå€é–“ï¼');
                return;
            }

            const dateFrom = new Date(dateFromStr + 'T00:00:00');
            const dateTo = new Date(dateToStr + 'T00:00:00');
            const allOrders = getOrders();

            const counts = {};
            let totalCount = 0;
            
            let currentDate = new Date(dateFrom);
            while (currentDate <= dateTo) {
                const dateKey = formatDate(currentDate);
                
                for (const key in allOrders) {
                    const order = allOrders[key];
                    const [orderDate, empId, mealType] = key.split('_');

                    if (orderDate === dateKey && order.IsOrdered) {
                        const countKey = `${orderDate}_${order.MealType}_${order.DietType}_${order.RicePortion}`;
                        counts[countKey] = (counts[countKey] || 0) + 1;
                        totalCount++;
                    }
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }


            if (totalCount === 0) {
                alert(`åœ¨ ${dateFromStr} ~ ${dateToStr} æœŸé–“æ²’æœ‰è¨‚å–®å¯ä¾›åŒ¯å‡ºï¼`);
                return;
            }

            let csvContent = "æ—¥æœŸ,é¤åˆ¥,è‘·ç´ ,é£¯é‡,æ•¸é‡\n";
            for (const [key, count] of Object.entries(counts)) {
                const [date, meal, diet, rice] = key.split('_');
                csvContent += `${date},${mealMap[meal]},${dietMap[diet]},${riceMap[rice]},${count}\n`;
            }

            const encodedUri = encodeURI(`\ufeff${csvContent}`); 
            const link = document.createElement("a");
            link.setAttribute("href", "data:text/csv;charset=utf-8," + encodedUri);
            link.setAttribute("download", `Meal_Quantity_Report_${dateFromStr}_to_${dateToStr}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // --- 2. åŒ¯å‡ºå“¡å·¥è¨‚è³¼æ•¸é‡çµ±è¨ˆè¡¨ (ç¶­æŒä¸è®Š) ---
        function exportEmployeeStats() {
            const dateFromStr = document.getElementById('order-date-from').value;
            const dateToStr = document.getElementById('order-date-to').value; 
            if (!dateFromStr || !dateToStr) {
                alert('è«‹å…ˆé¸æ“‡å®Œæ•´çš„æ—¥æœŸå€é–“ï¼');
                return;
            }     
            const dateFrom = new Date(dateFromStr + 'T00:00:00');
            const dateTo = new Date(dateToStr + 'T00:00:00');
            const allOrders = getOrders();
            // ä½¿ç”¨ getMasterEmployees ç¢ºä¿æœ€æ–°çš„å“¡å·¥è³‡æ–™
            const currentEmployees = getMasterEmployees(); 
            const employeeStats = {};
            let grandTotalCount = 0;

        
            currentEmployees.forEach(emp => {
                 employeeStats[emp.EmpID] = { 
                    name: emp.EmpName, 
                    lunchCount: 0, 
                    dinnerCount: 0, 
                    totalCount: 0 
                };
            });
            
            let currentDate = new Date(dateFrom);
            while (currentDate <= dateTo) {
                const dateKey = formatDate(currentDate);
                
                for (const key in allOrders) {
                    const order = allOrders[key];
                    const [orderDate, empId, mealType] = key.split('_');

                    if (orderDate === dateKey && order.IsOrdered && employeeStats[empId]) {
                        
                        employeeStats[empId].totalCount += 1;
                        grandTotalCount += 1;
                        
                        if (mealType === 'LUNCH') {
                            employeeStats[empId].lunchCount += 1;
                        } else if (mealType === 'DINNER') {
                            employeeStats[empId].dinnerCount += 1;
                        }
                    }
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            if (grandTotalCount === 0) {
                alert(`åœ¨ ${dateFromStr} ~ ${dateToStr} æœŸé–“æ²’æœ‰è¨‚å–®å¯ä¾›åŒ¯å‡ºï¼`);
                return;
            }

            let csvContent = "å“¡å·¥ID,å§“å,åˆé¤ç¸½æ•¸,æ™šé¤ç¸½æ•¸,è¨‚è³¼ç¸½æ•¸\n";
            const sortedEmpIds = Object.keys(employeeStats).sort();
            
            sortedEmpIds.forEach(id => {
                const stats = employeeStats[id];
                if (stats.totalCount > 0) { // åªåŒ¯å‡ºæœ‰è¨‚è³¼è¨˜éŒ„çš„å“¡å·¥
                    csvContent += `${id},${stats.name},${stats.lunchCount},${stats.dinnerCount},${stats.totalCount}\n`;
                }
            });

            const encodedUri = encodeURI(`\ufeff${csvContent}`); 
            const link = document.createElement("a");
            link.setAttribute("href", "data:text/csv;charset=utf-8," + encodedUri);
            link.setAttribute("download", `Employee_Order_Stats_${dateFromStr}_to_${dateToStr}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- 3. åŒ¯å‡ºå“¡å·¥æ¯æ—¥è¨‚è³¼æ˜ç´°è¡¨ (ç¶­æŒä¸è®Š) ---
        function exportDailyDetails() {
            const dateFromStr = document.getElementById('order-date-from').value;
            const dateToStr = document.getElementById('order-date-to').value;
            
            if (!dateFromStr || !dateToStr) {
                alert('è«‹å…ˆé¸æ“‡å®Œæ•´çš„æ—¥æœŸå€é–“ï¼');
                return;
            }
            
            const dateFrom = new Date(dateFromStr + 'T00:00:00');
            const dateTo = new Date(dateToStr + 'T00:00:00');
            const allOrders = getOrders();
            let allDetails = [];
            let totalDetailCount = 0;

            const currentEmployees = getMasterEmployees(); 
            const employeeMap = currentEmployees.reduce((map, emp) => {
                map[emp.EmpID] = emp.EmpName;
                return map;
            }, {});

            // 1. ç¯©é¸è¨‚å–®æ˜ç´°
            let currentDate = new Date(dateFrom);
            while (currentDate <= dateTo) {
                const dateKey = formatDate(currentDate);
                
                for (const key in allOrders) {
                    const order = allOrders[key];
                    const [orderDate, empId, mealType] = key.split('_');

                    if (orderDate === dateKey && order.IsOrdered) {
                        const empName = employeeMap[empId] || 'æœªçŸ¥';
                        allDetails.push({
                            Date: dateKey,
                            EmpID: empId,
                            EmpName: empName,
                            MealType: mealMap[order.MealType],
                            DietType: dietMap[order.DietType],
                            RicePortion: riceMap[order.RicePortion],
                            OrderTime: order.OrderTime || '',
                            AdminModified: order.AdminModified ? 'æ˜¯' : 'å¦'
                        });
                        totalDetailCount++;
                    }
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            if (totalDetailCount === 0) {
                alert(`åœ¨ ${dateFromStr} ~ ${dateToStr} æœŸé–“æ²’æœ‰è¨‚è³¼æ˜ç´°å¯ä¾›åŒ¯å‡ºï¼`);
                return;
            }

            // 2. æ•´ç† CSV å…§å®¹
            let csvContent = "æ—¥æœŸ,å“¡å·¥ID,å§“å,é¤åˆ¥,è‘·ç´ ,é£¯é‡,è¨‚è³¼æ™‚é–“,ç®¡ç†å“¡ä¿®æ”¹\n";
            
            // ç¢ºä¿æ˜ç´°æŒ‰æ—¥æœŸæ’åº
            allDetails.sort((a, b) => a.Date.localeCompare(b.Date));

            allDetails.forEach(detail => {
                csvContent += [
                    detail.Date,
                    detail.EmpID,
                    detail.EmpName,
                    detail.MealType,
                    detail.DietType,
                    detail.RicePortion,
                    detail.OrderTime,
                    detail.AdminModified
                ].join(',') + '\n';
            });

            // 3. ä¸‹è¼‰ CSV
            const encodedUri = encodeURI(`\ufeff${csvContent}`); 
            const link = document.createElement("a");
            link.setAttribute("href", "data:text/csv;charset=utf-8," + encodedUri);
            link.setAttribute("download", `Daily_Order_Details_${dateFromStr}_to_${dateToStr}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>